# SPDX-FileCopyrightText: 2023 - 2026 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

version: "1"

package:
  id: org.deepin.reader
  name: "deepin-reader"
  version: 6.5.51.1
  kind: app
  description: |
    reader for deepin os.

base: org.deepin.base/25.2.2
runtime: org.deepin.runtime.webengine/25.2.2

command:
  - deepin-reader

build: |
  # 下载和安装依赖
  apt -y install --download-only qt6-base-dev qt6-base-dev-tools qt6-tools-dev libdtk6widget-dev libspectre-dev libdjvulibre-dev libtiff-dev libjpeg-dev libicu-dev libpng-dev zlib1g-dev liblcms2-dev libopenjp2-7-dev libfreetype6-dev libgtest-dev libchardet-dev qt6-webengine-dev qt6-5compat-dev libdtk6gui-dev libdtk6core-dev qt6-svg-dev pandoc libgxps-dev libcairo2-dev libglib2.0-dev
  bash ./install_dep /var/cache/apt/archives "$PREFIX"

  # 设置INCLUDEPATH为引入的CFLAGS环境变量获取的路径
  sed -i '33i INCLUDEPATH += $$INCPATHS' 3rdparty/deepin-pdfium/src/src.pro
  sed -i '35i INCLUDEPATH += $$INCPATHS' htmltopdf/htmltopdf.pro
  sed -i '2i INCLUDEPATH += $$INCPATHS' reader/reader.pro
  sed -i 's|/usr/lib/qt6/bin/lrelease|lrelease|g' translate_generation.sh

  # 构建
  VERSION=$(head -1 debian/changelog | awk -F'[()]' '{print $2}')
  mkdir -p  build && cd build
  qmake -set APP_INSTALL_LIBS ${PREFIX}/lib/${TRIPLET}
  qmake "VERSION=${VERSION}" \
    "PREFIX=${PREFIX}" \
    "LINGLONG_BUILD_ON=1" \
    "INCPATHS=$(echo "$CFLAGS" | sed 's/-I//g')" \
    "LIB_INSTALL_DIR=${PREFIX}/lib/${TRIPLET}" \
    "INSTALL_ROOT=${PREFIX}" \
    ../deepin_reader.pro
  make -j`nproc`
  make install > ../install.log 2>&1
  cd ..

  # 项目生成应用名和动态隐式加载的依赖库，ldd无法找到的其他库
  LDD_FILES=(
    deepin-reader
    ../lib/deepin-reader/htmltopdf
    pandoc
    libdeepin-pdfium-reader.so
    # 定制插件不存在
    libzpdcallback.so
  )

  # 生成.install 文件
  ID_VALUE=$(awk -F ': ' '/^  id: / {print $2}' linglong.yaml)
  bash ./deploy_dep "${LDD_FILES[@]}"

  # lib/deepin-reader 文件添加到 install 文件
  for OTHER in "${PREFIX}"/lib/deepin-reader/*; do
      if [[ -f "$OTHER" ]]; then
          echo "$OTHER" >> "${ID_VALUE}.install"
      fi
  done

  EXEC_FILES=(
    pandoc
  )
  # 添加额外依赖进程到 install 文件
  for EXEFILE in "${PREFIX}/bin"/${EXEC_FILES[@]}*; do
    echo "$EXEFILE" >> "${ID_VALUE}.install"
  done

  # pandoc data 文件添加到 install 文件
  find "${PREFIX}/share/pandoc/" -type f -o -type d >> "${ID_VALUE}.install"

  # 添加帮助手册到 install
  find $PREFIX/share/deepin-manual/manual-assets/application/deepin-reader >> "${ID_VALUE}.install"

# allow apt download in build and do apt update
buildext:
  apt:
    build_depends:
      - libc6
